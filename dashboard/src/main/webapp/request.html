<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    	<script src="js/jquery.min.js" language="javascript"></script>
		<script src="js/highcharts.js" language="javascript"></script>
	</head>
	<body>
		<div>
			Data:
			<select id="selMethod" onchange="refresh()">
				<option selected value="count">Request Count</option>
				<option value="avg">Response Time (ms)</option>
			</select>
			Group By:
			<select id="selGroupBy" onchange="refresh()">
				<option value="">None</option>
				<option selected value="status">Status</option>
				<option value="path">Path</option>
				<option value="content_type">Content Type</option>
				<option value="charset">Character Encoding</option>
			</select>
			Interval:
			<select id="selInterval" onchange="refresh()">
				<option selected value="1">1 Minute</option>
				<option value="2">2 Minutes</option>
				<option value="5">5 Minutes</option>
				<option value="10">10 Minutes</option>
				<option value="20">20 Minutes</option>
				<option value="30">30 Minutes</option>
			</select>
		</div>
		<div id="container" style="width:100%;height:400px"></div>
		<script language="javascript"><!--

var MINUTE = 60000;

Highcharts.setOptions({
	global: {
		useUTC: false
	}
})

function drawChart(data, title, now, interval) {
	var options = {
		title: {
			text: title
		},
		legend: {
			align: 'right',
			verticalAlign: 'top',
			layout: 'vertical'
		},
		xAxis: {
			type:'datetime'
		},
		tooltip: {
			formatter: function() {
				return Highcharts.dateFormat("%Y-%m-%d %H:%M:%S", this.x) + "<br/><b>" +
						Highcharts.numberFormat(this.y, 2) + "</b>";
			}
		},
		series: []
	};

	var keys = [], valueMap = {};
	for (var key in data) {
		var line = data[key];
		var lineLen = line.length;
		var value = 0;
		for (var i = 0; i < lineLen; i ++) {
			value += line[i];
		}
		keys.push(key);
		valueMap[key] = value;
	}
	keys.sort(function(key1, key2) {
		return valueMap[key2] - valueMap[key1];
	});
	var linesLen = Math.min(keys.length, 10), sorted = {};
	for (var i = 0; i < linesLen; i ++) {
		var key = keys[i];
		sorted[" " + key] = data[key];
	}
	var start = now - 60 * interval;
	for (var key in sorted) {
		options.series.push({
			name: key,
			pointStart: start * MINUTE,
			pointInterval: interval * MINUTE,
			data: sorted[key]
		});
	}
	$('#container').highcharts(options);
}

function requestApi() {
	var method = selMethod.value;
	var title = selMethod.options[selMethod.selectedIndex].innerHTML;
	var groupBy = selGroupBy.value;
	var interval = parseInt(selInterval.value);
	var now = Math.floor(new Date().getTime() / MINUTE);
	var xhr = new XMLHttpRequest();
	xhr.onload = function() {
		drawChart(eval("(" + xhr.responseText + ")"), title, now, interval);
	};
	xhr.open("GET", "api/xqbase.webapp.request_time/" + method + "?_r=" +
			Math.random() + "&_end=" + now + "&_interval=" + interval +
			"&_length=60" + (groupBy == "" ? "" : "&_group_by=" + groupBy), true);
	xhr.send(null);
}

var timer = null;

function refresh() {
	if (timer != null) {
		clearInterval(timer);
	}
	timer = setInterval(requestApi, MINUTE);
	requestApi();
}

refresh();

		--></script>
	</body>
</html>